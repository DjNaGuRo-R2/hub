# "Helm" jobs
# See https://gitlab.com/go2scale/jobs/ for more informations

.helm:
  image: lachlanevenson/k8s-helm:v3.0.2
  variables:
    CHART_PATH: "./charts/$CI_PROJECT_NAME"
    VALUES_PATH: "./conf/values"
    REGISTRY: "${CI_REGISTRY_IMAGE}"
    KUBECTL_URL: "https://storage.googleapis.com/kubernetes-release/release/v1.17.0/bin/linux/amd64/kubectl"
    HELMSECRETS_URL: "https://github.com/futuresimple/helm-secrets"
    HELMSECRETS_VERSION: "v2.0.2"
    STABLE_REPO_URL: "https://kubernetes-charts.storage.googleapis.com/"
  before_script:
    - apk add --no-cache curl gnupg
    - curl --output /bin/kubectl ${KUBECTL_URL} \
      && chmod a+x /bin/kubectl \
      && mkdir ${HELM_HOME}/plugins \
      && helm plugin install $HELMSECRETS_URL --version ${HELMSECRETS_VERSION}
    - gpg --import "${PGP_PUBLIC}"
    - gpg --allow-secret-key-import --import "${PGP_PRIVATE}"
    - helm repo add stable ${STABLE_REPO_URL}
    - helm repo update


deploy_review:
  extends: .helm
  stage: review
  environment:
    name: review/${CI_COMMIT_REF_SLUG}
    url: https://${CI_ENVIRONMENT_SLUG}.${CI_PROJECT_NAME}.${KUBE_INGRESS_BASE_DOMAIN}/
    on_stop: cleanup_review
  except:
    refs:
      - master
    variables:
      - ${REVIEW_DISABLE}
  script:
    - if [ -f "${VALUES_PATH}/secrets.review.yaml" ]
    - then
    -     SECRET_OPTION="-f ${VALUES_PATH}/secrets.review.yaml"
    - fi
- 
    - # Deploy
    - helm secrets upgrade ${CI_PROJECT_PATH_SLUG} ${CHART_PATH} \
    -     --namespace "${KUBE_NAMESPACE}" --install \
    -     -f ${VALUES_PATH}/review.yaml ${SECRET_OPTION}\
    -     --set-string image.registry=${REGISTRY} \
    -     --set-string image.tag=${CI_COMMIT_SHA} \
    -     --set-string ingress.hostPrefix="${CI_ENVIRONMENT_SLUG}." \
    -     --set-string gitlab.env=${CI_ENVIRONMENT_SLUG} \
    -     --set-string gitlab.app=${CI_PROJECT_PATH_SLUG}

cleanup_review:
  extends: .helm
  stage: review
  variables:
    GIT_STRATEGY: none
  when: manual
  script:
    - helm ls --all --short -n ${KUBE_NAMESPACE} | xargs -L1 helm -n ${KUBE_NAMESPACE} delete
#    - kubectl delete namespace $KUBE_NAMESPACE # TODO: it's forbidden due tu user RBAC
  environment:
    name: review/${CI_COMMIT_REF_SLUG}
    action: stop
  allow_failure: true
  except:
    refs:
      - master
    variables:
      - ${REVIEW_DISABLE}

#test_stage:
#  extends: deploy_stage
#  stage: application_level
#  script:
#    - helm secrets diff upgrade ${CI_PROJECT_PATH_SLUG} ${CHART_PATH} -f ${VALUES_PATH}/${ENV}.yaml -f ${VALUES_PATH}/secrets.${ENV}.yaml --set-string image.tag=${CI_COMMIT_SHORT_SHA} --namespace "$KUBE_NAMESPACE" --allow-unreleased

deploy_stage:
  extends: .helm
  stage: staging
  environment:
    name: staging
    url: https://${CI_ENVIRONMENT_SLUG}.${CI_PROJECT_NAME}.${KUBE_INGRESS_BASE_DOMAIN}/
  only:
    - master
  except:
    variables:
      - ${STAGING_DISABLE}

#test_production:
#  extends: deploy_production
#  stage: application_level
#  script:
#    - helm secrets diff upgrade ${CI_PROJECT_PATH_SLUG} ${CHART_PATH} -f ${VALUES_PATH}/${ENV}.yaml -f ${VALUES_PATH}/secrets.${ENV}.yaml --set-string image.tag=${CI_COMMIT_SHORT_SHA} --namespace "$KUBE_NAMESPACE" --allow-unreleased

deploy_production:
  extends: .helm
  stage: production
  environment:
    name: production
    url: https://${CI_PROJECT_NAME}.${KUBE_INGRESS_BASE_DOMAIN}/
  when: manual
  only:
    - master
  except:
    variables:
      - ${PRODUCTION_DISABLE}
