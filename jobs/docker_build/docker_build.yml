docker_build:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug-v0.20.0
    entrypoint: [""]
  variables:
    IMAGE: ""
    COMMIT_CREATE_LATEST: "false"
    TAG_CREATE_LATEST: "true"
  script:
    - mkdir -p /kaniko/.docker/
    - if [ -z ${IMAGE} ]; then
    -   if [ ! -z ${CI_COMMIT_TAG} ]; then
    -     IMAGE=${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}
    -     if [[ ${TAG_CREATE_LATEST} == "true" ]]; then
    -       DESTINATIONS="--destination ${CI_REGISTRY_IMAGE}:latest"
    -     fi
    -   else; then
    -     IMAGE=${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA}
    -     if [[ ${COMMIT_CREATE_LATEST} == "true" ]]; then
    -       DESTINATIONS="--destination ${CI_REGISTRY_IMAGE}:latest"
    -     fi
    -   fi
    - fi
    - DESTINATIONS+="--destination ${IMAGE}"
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context ${CI_PROJECT_DIR} --dockerfile ${CI_PROJECT_DIR}/Dockerfile ${DESTINATIONS}
