docker_build:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug-v0.20.0
    entrypoint: [""]
  variables:
    IMAGE: ""
    DESTINATIONS: "--destination ${IMAGE}"
    COMMIT_CREATE_LATEST: "False"
    TAG_CREATE_LATEST: "True"
  script:
    - mkdir -p /kaniko/.docker/
    - if [ -z ${IMAGE} ]; then
    -   if [ ! -z ${CI_COMMIT_SHA} ]; then
    -     IMAGE=${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA}
    -   elif [ ! -z ${CI_COMMIT_TAG} ]; then
    -     IMAGE=${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}
    -   fi
    - fi
    - if [ ! -z ${CI_COMMIT_SHA} ]; then
    -   if [[ ${COMMIT_CREATE_LATEST} == "True" ]]; then
    -     DESTINATIONS+="--destination ${CI_REGISTRY_IMAGE}:latest"
    -   fi
    - elif [ ! -z ${CI_COMMIT_TAG} ]; then
    -   if [[ ${TAG_CREATE_LATEST} == "True" ]]; then
    -     DESTINATIONS+="--destination ${CI_REGISTRY_IMAGE}:latest"
    -   fi
    - fi
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context ${CI_PROJECT_DIR} --dockerfile ${CI_PROJECT_DIR}/Dockerfile ${DESTINATIONS}
