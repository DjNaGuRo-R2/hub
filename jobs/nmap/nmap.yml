stages:
  - dynamic_tests

nmap:
  image:
    name: instrumentisto/nmap:7.92
    entrypoint: [""]
  stage: dynamic_tests
  variables:
    NMAP_TARGET: "app"
    NMAP_SCRIPTS: ""
    NMAP_OPTIONS: ""
    NMAP_OUTPUT: "nmap-report.xml"
    HTML_OUTPUT: "nmap-report.html"
    LIBXSLT_VERSION: "1.1.34-r1"
  script:
    - apk add --no-cache "libxslt=${LIBXSLT_VERSION}"
    - if [[ ! -z ${NMAP_SCRIPTS} ]]; then
    -   NMAP_OPTIONS="--script=${NMAP_SCRIPTS} ${NMAP_OPTIONS}"
    - fi
    - nmap -oX ${NMAP_OUTPUT} ${NMAP_OPTIONS} ${NMAP_TARGET}
    - xsltproc ${NMAP_OUTPUT} -o ${HTML_OUTPUT}
  artifacts:
    expose_as: "Nmap report"
    when: always
    paths:
      - "${HTML_OUTPUT}"
      # Below path is a workaround to provide artifact exposition in MR if
      # default output value is used. See https://r2devops.io/jobs/dynamic_tests/nmap/#artifacts
      - "nmap-report.html"
